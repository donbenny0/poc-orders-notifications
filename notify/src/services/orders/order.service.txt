
import { Order } from '@commercetools/platform-sdk';
import { OrderNotFoundError, FetchOrderError } from '../../errors/order.error';
import { transformOrder } from './orders.service';

// Mock the entire module
jest.mock('../../client/create.client', () => ({
    createApiRoot: jest.fn()
}));

describe('getOrder.repository.ts', () => {
    let mockExecute: jest.Mock<Promise<{ body: { id: string; state: string } }>>;

    beforeEach(() => {
        // Reset the mock before each test
        jest.resetAllMocks();

        // Set up the mock structure
        mockExecute = jest.fn().mockResolvedValue({ body: { id: '123', state: 'Confirmed' } });
        const mockGet = jest.fn().mockReturnValue({ execute: mockExecute });
        const mockWithId = jest.fn().mockReturnValue({ get: mockGet });
        const mockOrders = jest.fn().mockReturnValue({ withId: mockWithId });

        // Mock the createApiRoot function
        require('../../client/create.client').createApiRoot.mockReturnValue({
            orders: mockOrders
        });
    });

    it('should fetch order by ID', async () => {
        const orderMock: Order = {
            id: '123',
            shippingAddress: { firstName: "jhon", mobile: '+1234567890' },
            // Add other properties as needed...
        } as any;
        const order = await transformOrder(orderMock);
        expect(order).toEqual({ id: '123', state: 'Confirmed' });
    });

    it('should throw OrderNotFoundError if order does not exist', async () => {
        const orderMock: Order = {
            id: '123',
            shippingAddress: { firstName: "jhon", mobile: '+1234567890' },
            // Add other properties as needed...
        } as any;
        mockExecute.mockRejectedValue({ statusCode: 404 });

        await expect(transformOrder(orderMock)).rejects.toThrow(OrderNotFoundError);
    });

    it('should throw FetchOrderError for other errors', async () => {
        const orderMock: Order = {
            id: '123',
            shippingAddress: { firstName: "jhon", mobile: '+1234567890' },
            // Add other properties as needed...
        } as any;
        mockExecute.mockRejectedValue(new Error('Some other error'));

        await expect(transformOrder(orderMock)).rejects.toThrow(FetchOrderError);
    });
});
